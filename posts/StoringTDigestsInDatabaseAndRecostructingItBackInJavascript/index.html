<!DOCTYPE html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Storing TDigests In A Database And Reconstructing It Back In Javascript" /><meta property="og:locale" content="en" /><meta name="description" content="Storing TDigests In A Database And Reconstructing It Back In Javascript" /><meta property="og:description" content="Storing TDigests In A Database And Reconstructing It Back In Javascript" /><link rel="canonical" href="https://yasassri.github.io/posts/StoringTDigestsInDatabaseAndRecostructingItBackInJavascript/" /><meta property="og:url" content="https://yasassri.github.io/posts/StoringTDigestsInDatabaseAndRecostructingItBackInJavascript/" /><meta property="og:site_name" content="Yasassri Ratnayake" /><meta property="og:image" content="https://yasassri.github.io/assets/img/posts/percentiles.jpg" /><meta property="og:image:height" content="500" /><meta property="og:image:width" content="800" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-09-15T00:00:00-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://yasassri.github.io/assets/img/posts/percentiles.jpg" /><meta property="twitter:title" content="Storing TDigests In A Database And Reconstructing It Back In Javascript" /><meta name="twitter:site" content="@yasassrir" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-09-15T00:00:00-04:00","datePublished":"2023-09-15T00:00:00-04:00","description":"Storing TDigests In A Database And Reconstructing It Back In Javascript","headline":"Storing TDigests In A Database And Reconstructing It Back In Javascript","image":{"width":800,"height":500,"alt":null,"url":"https://yasassri.github.io/assets/img/posts/percentiles.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yasassri.github.io/posts/StoringTDigestsInDatabaseAndRecostructingItBackInJavascript/"},"url":"https://yasassri.github.io/posts/StoringTDigestsInDatabaseAndRecostructingItBackInJavascript/"}</script><title>Storing TDigests In A Database And Reconstructing It Back In Javascript | Yasassri Ratnayake</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Yasassri Ratnayake"><meta name="application-name" content="Yasassri Ratnayake"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/favicons/android-chrome-512x512.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Yasassri Ratnayake</a></div><div class="site-subtitle font-italic">My Personal Web Space</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/otherblogs/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>OTHER BLOGS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/yasassri" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://stackoverflow.com/users/2627018/ycr" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.linkedin.com/in/yasassriratnayake" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ycrnet','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Storing TDigests In A Database And Reconstructing It Back In Javascript</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Storing TDigests In A Database And Reconstructing It Back In Javascript</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1694750400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 15, 2023 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 500'%3E%3C/svg%3E" data-src="/assets/img/posts/percentiles.jpg" class="preview-img bg" alt="Preview Image" width="800" height="500" data-proofer-ignore></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/yasassri">Yasassri Ratnayake</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1086 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p><a href="https://www.sciencedirect.com/science/article/pii/S2665963820300403">T-Digest</a> is a statistical algorithm used for approximate calculation of quantiles and percentiles from large data sets. It’s particularly useful when you have a vast amount of data and you want to quickly estimate values like the median, quartiles, or any other percentile without having to process the entire dataset. Once the large dataset is processed the data will be added to the TDigest and from the Digest we are able to estimate the quantiles. In some cases, you may want to persist the TDigest so you can use that data at a different point. In this post, we will explore how we can persist the tidest we create with Nodejs in SQLServer and then reconstruct it.</p><p>Before we go into the solution it’s important to understand Centroids in TDigest. In essence, centroids in T-Digest serve as central values or representatives of quantile ranges within the data distribution. We will be using these Centroids when storing the Digest in the DB.</p><p>Once we create the Digest in Javascript, the main problem with the TDigest object that we create is, that it’s not serializable, there isn’t an inbuilt mechanism in the TDigest implementation(Javascript version) to serialize the data out of the box. So as a workaround, we will be extracting all the Centroids from the digest and then storing it in the DB which will allow us to reconstruct the Digest from the DB.</p><p>Okay, let’s go to the solution.</p><h3 id="prerequisites"><span class="mr-2">Prerequisites.</span><a href="#prerequisites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>For this example, I’ll be using SQLServer and NodeJS. So these are the only dependencies. Then of course we need the TDigest <a href="https://github.com/welch/tdigest">npm module</a> for this. Assuming you have <code class="language-plaintext highlighter-rouge">node</code> setup you can simply use <code class="language-plaintext highlighter-rouge">npm</code> to install the dependencies.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>npm <span class="nb">install </span>tdigest mssql
</pre></table></code></div></div><p>Then let’s create a simple Database and a table to store the data. For this, I’m using the SQLServer Docker image so I can quickly set up a DB locally to do the implementation etc.</p><p>Let’s start the docker image.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">-e</span> <span class="s2">"ACCEPT_EULA=Y"</span> <span class="nt">-e</span> <span class="s2">"MSSQL_SA_PASSWORD=Root#Pass"</span> <span class="nt">-p</span> 1433:1433 <span class="nt">-d</span> mcr.microsoft.com/mssql/server:2022-latest
</pre></table></code></div></div><p>Then let’s create a simple table to store the data. I have a column named <code class="language-plaintext highlighter-rouge">digest</code> with the type <code class="language-plaintext highlighter-rouge">varbinary</code> to store the digest as binary data.</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">TDigests</span> <span class="p">(</span>
	<span class="n">id</span> <span class="nb">INT</span> <span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="n">digest</span> <span class="nb">varbinary</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="p">);</span>
</pre></table></code></div></div><h3 id="storing-the-data"><span class="mr-2">Storing the data</span><a href="#storing-the-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now we need to construct a TDigest and store it in the database.</p><p>The following code will generate a digest and add 100,000 entries to it.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">digest</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TDigest</span><span class="p">();</span>

<span class="c1">// Add 100000 random records to the T-Digest</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">digest</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getRandomInt</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>
<span class="p">}</span>
<span class="nx">digest</span><span class="p">.</span><span class="nx">compress</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">90th Percentile before saving: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">digest</span><span class="p">.</span><span class="nx">percentile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">));</span>
</pre></table></code></div></div><p>Once the digest is created we can use the <code class="language-plaintext highlighter-rouge">digest.toArray()</code> as in <a href="https://github.com/welch/tdigest/blob/cf73bdd0544c4b0b5e9b34a423e888c3c5b26413/tdigest.js#L46">here</a> to extract all the centroids. Once the centroid array is retrieved you can use the <code class="language-plaintext highlighter-rouge">JSON.stringify()</code> method to convert the Javascript object to a JSON object, which will allow us to store the data as a JSON object in the database.</p><p>Now let’s create a prepared statement and insert the data into the Database.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">ps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">PreparedStatement</span><span class="p">(</span><span class="nx">pool</span><span class="p">);</span>
<span class="nx">ps</span><span class="p">.</span><span class="nx">input</span><span class="p">(</span><span class="dl">'</span><span class="s1">digest</span><span class="dl">'</span><span class="p">,</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">NVarChar</span><span class="p">);</span> <span class="c1">// When we are storing the data we will compress it</span>

<span class="k">await</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">prepare</span><span class="p">(</span><span class="s2">`INSERT INTO </span><span class="p">${</span><span class="nx">tableName</span><span class="p">}</span><span class="s2"> VALUES (COMPRESS(@digest))`</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span> <span class="dl">'</span><span class="s1">digest</span><span class="dl">'</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">digest</span><span class="p">.</span><span class="nx">toArray</span><span class="p">())</span> <span class="p">});</span>
</pre></table></code></div></div><p>In the above insert statement note the <code class="language-plaintext highlighter-rouge">COMPRESS()</code> SQLServer function which allows us to convert the JSON string into binary content before storing it in the DB. This will allow us to save a considerable amount of space in the DB. Also, compression is not mandatory. You can do the compression at the code level as well if that’s what you prefer.</p><h3 id="retreiving-the-data"><span class="mr-2">Retreiving the data</span><a href="#retreiving-the-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Once you insert the data you can retrieve the data using the following code.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">getDigestQuery</span> <span class="o">=</span> <span class="s2">`SELECT CAST(DECOMPRESS(digest) AS NVARCHAR(MAX)) AS digest 
                            FROM </span><span class="p">${</span><span class="nx">tableName</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">getDigestQuery</span><span class="p">)</span>
</pre></table></code></div></div><p>Note when reading the digest we have to decompress it and convert it to a String so we can pass it back to a JSON. Once that is done we can use the following code the recontruct the digest back. For that, we can use <code class="language-plaintext highlighter-rouge">digest.push_centroid()</code> method as in <a href="https://github.com/welch/tdigest/blob/cf73bdd0544c4b0b5e9b34a423e888c3c5b26413/tdigest.js#L93">here</a>.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nx">result</span><span class="p">.</span><span class="nx">recordset</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">element</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">newDigest</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TDigest</span><span class="p">();</span>
        <span class="nx">newDigest</span><span class="p">.</span><span class="nx">push_centroid</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">digest</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">90th Percentile after constructing: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">newDigest</span><span class="p">.</span><span class="nx">percentile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">));</span>
    <span class="p">});</span>
</pre></table></code></div></div><p>So that’s it. The complete code is something like below.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">sql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mssql</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">TDigest</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">tdigest</span><span class="dl">'</span><span class="p">);</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">SQL_CONFIG</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">SA</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">SQL_CONFIG</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Root#Pass</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">SQL_CONFIG</span><span class="p">.</span><span class="nx">server</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">localhost</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">SQL_CONFIG</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="mi">1433</span><span class="p">;</span>
    <span class="nx">SQL_CONFIG</span><span class="p">.</span><span class="nx">database</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">master</span><span class="dl">'</span>

    <span class="kd">const</span> <span class="nx">tableName</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">TDigests</span><span class="dl">"</span><span class="p">;</span>

    <span class="kd">let</span> <span class="nx">pool</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getDBPool</span><span class="p">();</span>

    <span class="c1">// Initialize a T-Digest data structure</span>
    <span class="kd">const</span> <span class="nx">digest</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TDigest</span><span class="p">();</span>

    <span class="c1">// Add 100000 random records to the T-Digest</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">digest</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getRandomInt</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nx">digest</span><span class="p">.</span><span class="nx">compress</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">90th Percentile before saving: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">digest</span><span class="p">.</span><span class="nx">percentile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">));</span>
    <span class="kd">const</span> <span class="nx">ps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">PreparedStatement</span><span class="p">(</span><span class="nx">pool</span><span class="p">);</span>
    <span class="nx">ps</span><span class="p">.</span><span class="nx">input</span><span class="p">(</span><span class="dl">'</span><span class="s1">digest</span><span class="dl">'</span><span class="p">,</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">NVarChar</span><span class="p">);</span> <span class="c1">// When we are storing the data we will compress it</span>

    <span class="k">await</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">prepare</span><span class="p">(</span><span class="s2">`INSERT INTO </span><span class="p">${</span><span class="nx">tableName</span><span class="p">}</span><span class="s2"> VALUES (COMPRESS(@digest))`</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span> <span class="dl">'</span><span class="s1">digest</span><span class="dl">'</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">digest</span><span class="p">.</span><span class="nx">toArray</span><span class="p">())</span> <span class="p">});</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Ok we are done saving the digest, Now let's read and construct it back</span><span class="dl">"</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">getDigestQuery</span> <span class="o">=</span> <span class="s2">`SELECT CAST(DECOMPRESS(digest) AS NVARCHAR(MAX)) AS digest 
                            FROM </span><span class="p">${</span><span class="nx">tableName</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">getDigestQuery</span><span class="p">);</span>

    <span class="nx">result</span><span class="p">.</span><span class="nx">recordset</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">element</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">newDigest</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TDigest</span><span class="p">()</span>
        <span class="nx">newDigest</span><span class="p">.</span><span class="nx">push_centroid</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">digest</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">90th Percentile after constructing: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">newDigest</span><span class="p">.</span><span class="nx">percentile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="nx">ps</span><span class="p">.</span><span class="nx">unprepare</span><span class="p">();</span>
    <span class="nx">pool</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Function to generate a random integer between min and max (inclusive)</span>
<span class="kd">function</span> <span class="nx">getRandomInt</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="nx">min</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">SQL_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">user</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span>
    <span class="na">database</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span>
    <span class="na">server</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">1433</span><span class="p">,</span>
    <span class="na">pool</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">max</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="na">min</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">idleTimeoutMillis</span><span class="p">:</span> <span class="mi">60000</span>
    <span class="p">},</span>
    <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">encrypt</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">trustServerCertificate</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">trustedConnection</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="kd">function</span> <span class="nx">getDBPool</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">poolPromise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">ConnectionPool</span><span class="p">(</span><span class="nx">SQL_CONFIG</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">connect</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">pool</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Connected to MSSQL</span><span class="dl">'</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">pool</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="nx">poolPromise</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">main</span> <span class="o">===</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">main</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>You can find the full code at <a href="https://github.com/yasassri/tdigest-persist-sample">Github</a> as well.</p><p>Hope the above helps someone. Please drop a comment if you have any questions.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/tdigest/" class="post-tag no-text-decoration" >TDigest</a> <a href="/tags/node/" class="post-tag no-text-decoration" >Node</a> <a href="/tags/javascript/" class="post-tag no-text-decoration" >Javascript</a> <a href="/tags/algorithms/" class="post-tag no-text-decoration" >Algorithms</a> <a href="/tags/sqlserver/" class="post-tag no-text-decoration" >SQLServer</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Storing+TDigests+In+A+Database+And+Reconstructing+It+Back+In+Javascript+-+Yasassri+Ratnayake&url=https%3A%2F%2Fyasassri.github.io%2Fposts%2FStoringTDigestsInDatabaseAndRecostructingItBackInJavascript%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Storing+TDigests+In+A+Database+And+Reconstructing+It+Back+In+Javascript+-+Yasassri+Ratnayake&u=https%3A%2F%2Fyasassri.github.io%2Fposts%2FStoringTDigestsInDatabaseAndRecostructingItBackInJavascript%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fyasassri.github.io%2Fposts%2FStoringTDigestsInDatabaseAndRecostructingItBackInJavascript%2F&text=Storing+TDigests+In+A+Database+And+Reconstructing+It+Back+In+Javascript+-+Yasassri+Ratnayake" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/OverrridingjavaOptionsInjectedToJavaProcesses/">Solving Datadog Java Agent Conflicts in Kubernetes With A Simple C Library</a><li><a href="/posts/Delaying-Container-startup-until-a-Kubernetes-resources-are-created/">Delaying Application Startup Until Kubernetes Resources are Created</a><li><a href="/posts/ConvertingJavaClientToANativeExcutableWithGraalVM/">Converting Java CLI Client to a Native Executable with GraalVM</a><li><a href="/posts/Keeping-Your-WSO2-Products-up-to-date-in-a-ContainerisedEnv/">Keeping Your WSO2 Products up-to-date in a Containerised Environment</a><li><a href="/posts/CreateJenkinsCredentialsThroughRestAPI/">Create Jenkins Credentials Through Rest API</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/wso2/">wso2</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/cicd/">cicd</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/jenkins/">jenkins</a> <a class="post-tag" href="/tags/wso2mi/">wso2mi</a> <a class="post-tag" href="/tags/groovy/">groovy</a> <a class="post-tag" href="/tags/testing/">testing</a> <a class="post-tag" href="/tags/wso2ei/">wso2ei</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ConvertingJavaClientToANativeExcutableWithGraalVM/"><div class="card-body"> <em class="small" data-ts="1665892800" data-df="ll" > Oct 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Converting Java CLI Client to a Native Executable with GraalVM</h3><div class="text-muted small"><p> GraalVM is a high-performance JDK distribution designed to accelerate the execution of applications written in Java and other JVM languages along with support for JavaScript, Ruby, Python, and a nu...</p></div></div></a></div><div class="card"> <a href="/posts/OverrridingjavaOptionsInjectedToJavaProcesses/"><div class="card-body"> <em class="small" data-ts="1750564800" data-df="ll" > Jun 22, 2025 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Solving Datadog Java Agent Conflicts in Kubernetes With A Simple C Library</h3><div class="text-muted small"><p> Solving Datadog Java Agent Conflicts in Kubernetes With A Simple C Library Recently, I ran into an issue where Datadog’s admission controller was automatically injecting JAVA_TOOL_OPTIONS into our...</p></div></div></a></div><div class="card"> <a href="/posts/Delaying-Container-startup-until-a-Kubernetes-resources-are-created/"><div class="card-body"> <em class="small" data-ts="1715745600" data-df="ll" > May 15, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Delaying Application Startup Until Kubernetes Resources are Created</h3><div class="text-muted small"><p> In this post, I will take you through the process I followed when trying to debug an issue that was occurring in one of the applications deployed in K8S. If you are just interested in the part ment...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ConvertingJavaClientToANativeExcutableWithGraalVM/" class="btn btn-outline-primary" prompt="Older"><p>Converting Java CLI Client to a Native Executable with GraalVM</p></a> <a href="/posts/Delaying-Container-startup-until-a-Kubernetes-resources-are-created/" class="btn btn-outline-primary" prompt="Newer"><p>Delaying Application Startup Until Kubernetes Resources are Created</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "yasassri/yasassri.github.io", "data-repo-id": "R_kgDOHmz8Lw", "data-category": "comments", "data-category-id": "DIC_kwDOHmz8L84CRzO5", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/yasassri">Yasassri Ratnayake</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/wso2/">wso2</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/cicd/">cicd</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/jenkins/">jenkins</a> <a class="post-tag" href="/tags/wso2mi/">wso2mi</a> <a class="post-tag" href="/tags/groovy/">groovy</a> <a class="post-tag" href="/tags/testing/">testing</a> <a class="post-tag" href="/tags/wso2ei/">wso2ei</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-0LZHF72L8B"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-0LZHF72L8B'); }); </script>
